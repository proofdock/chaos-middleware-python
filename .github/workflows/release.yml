name: Release to PyPI

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      - name: Build and upload distributions
        run: |
          # Return immediately on any error and print error output to standard error output.
          set -ev

          BASEDIR=$PWD

          echo -e "[pypi]" >> ~/.pypirc
          echo -e "username = ${{ secrets.PYPI_USERNAME }}" >> ~/.pypirc
          echo -e "password = ${{ secrets.PYPI_PASSWORD }}" >> ~/.pypirc

          # Ensure that we have the latest versions of Twine, Wheel, and Setuptools.
          python -m pip install --upgrade twine wheel setuptools

          # Build the distributions.
          for d in src/*/ ; do
            pushd .
            cd "$d"
            python setup.py bdist_wheel --dist-dir "$BASEDIR/dist/"
            popd
          done

          # Upload the distributions.
          for p in dist/* ; do
            twine upload --skip-existing $p
          done
